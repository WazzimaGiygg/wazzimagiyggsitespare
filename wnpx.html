// --- Configuração do Firebase ---
const firebaseConfig = {
    apiKey: "AIzaSyB9GkSqTIZ0kbVsba_WOdQeVAETrF9qna0",
    authDomain: "wzzm-ce3fc.firebaseapp.com",
    projectId: "wzzm-ce3fc",
    storageBucket: "wzzm-ce3fc.appspot.com",
    messagingSenderId: "249427877153",
    appId: "1:249427877153:web:0e4297294794a5aadeb260",
    measurementId: "G-PLKNZNFCQ8"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();
const storage = firebase.storage();

// --- Elementos do DOM ---
const authStatus = document.getElementById('auth-status');
const mainDashboard = document.getElementById('main-dashboard');
const loginButton = document.getElementById('login-button');
const logoutButton = document.getElementById('logout-button');
const articleList = document.getElementById('article-list');
const articleDetails = document.getElementById('article-details');
const editFormContainer = document.getElementById('edit-form-container');
const formEdicaoArtigo = document.getElementById('form-edicao-artigo');
const profileSection = document.getElementById('profile-section');
const profileLink = document.getElementById('profile-link');
const userDisplay = document.getElementById('user-display');
const loading = document.getElementById('loading');
const resultDiv = document.getElementById('result');
const contentSubmitForm = document.getElementById('content-submit-form');
const contentTextarea = document.getElementById('content-textarea');

// --- Estado da Aplicação ---
let selectedArticleDocId = null;
let selectedArticleData = null;

// --- Monitora o estado da autenticação ---
auth.onAuthStateChanged(user => {
    if (user) {
        authStatus.style.display = 'none';
        mainDashboard.style.display = 'flex';
        carregarArtigos();
    } else {
        authStatus.style.display = 'block';
        mainDashboard.style.display = 'none';
    }
});

// --- Funções de Navegação e Carregamento de Dados ---
const sections = document.querySelectorAll('.content-section');
function navigateTo(sectionId) {
    sections.forEach(section => {
        section.style.display = 'none';
    });
    document.getElementById(sectionId).style.display = 'block';
}

document.querySelectorAll('.nav-link').forEach(link => {
    link.addEventListener('click', (e) => {
        e.preventDefault();
        // Limpa a seleção do filtro ao mudar de seção
        document.querySelectorAll('.nav-link-filter').forEach(l => l.classList.remove('active'));
        navigateTo(`section-${e.target.dataset.section}`);
    });
});

// --- Funções de Submissão de Conteúdo (Novo Artigo) ---
const getBase64 = (file) => {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = error => reject(error);
    });
}

contentSubmitForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    loading.style.display = 'block';
    resultDiv.innerHTML = '';

    const user = auth.currentUser;
    if (!user) {
        alert("Você precisa estar logado para publicar.");
        loading.style.display = 'none';
        return;
    }

    const title = document.getElementById('title').value;
    const sector = document.getElementById('sector').value;
    const content = contentTextarea.value;
    const termsConsent = document.getElementById('terms-consent').checked;
    const imageFile = document.getElementById('image-upload').files[0];

    try {
        let imageUrlCode = null;
        let imageDocId = null;

        if (imageFile) {
            const imageBase64 = await getBase64(imageFile);
            const imageRef = await db.collection('imagenscode').add({
                base64_code: imageBase64,
                original_name: imageFile.name,
                upload_date: firebase.firestore.FieldValue.serverTimestamp()
            });
            imageDocId = imageRef.id;
            imageUrlCode = `[IMAGEM_ID:${imageDocId}]`;
            resultDiv.innerHTML += `<p>Imagem salva com sucesso! ID: <strong>${imageDocId}</strong></p>`;
        }

        await db.collection('wazzimagiyggfemboyverse69').add({
            title: title,
            sector: sector,
            date: firebase.firestore.FieldValue.serverTimestamp(),
            content: content,
            author_uid: user.uid,
            agreed_terms: termsConsent,
            image_reference: imageUrlCode
        });

        resultDiv.innerHTML += `<p>Documento publicado com sucesso na coleção "wazzimagiyggfemboyverse69".</p>`;
        contentSubmitForm.reset();
    } catch (error) {
        console.error("Erro ao publicar: ", error);
        resultDiv.innerHTML = `<p style="color:red;">Ocorreu um erro ao publicar o conteúdo. Tente novamente.</p>`;
    } finally {
        loading.style.display = 'none';
    }
});

// --- Funções de Login e Logout (existentes, com pequenas modificações) ---
loginButton.addEventListener('click', () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider).catch(error => {
        console.error("Erro no login:", error);
        alert("Ocorreu um erro ao fazer login. Tente novamente.");
    });
});

logoutButton.addEventListener('click', () => {
    auth.signOut();
    navigateTo('section-all-articles');
});

// --- Lógica do Painel (Corrigida) ---
function carregarArtigos(filtroCategoria = 'todos') {
    articleList.innerHTML = '<p>Carregando artigos...</p>';
    let query = db.collection('wazzimagiyggfemboyverse69').orderBy('date', 'desc');

    if (filtroCategoria !== 'todos') {
        query = query.where('sector', '==', filtroCategoria);
    }

    query.get().then(snapshot => {
        articleList.innerHTML = '';
        if (snapshot.empty) {
            articleList.innerHTML = '<p>Nenhum artigo encontrado.</p>';
            return;
        }
        snapshot.forEach(doc => {
            const item = doc.data();
            const listItem = document.createElement('div');
            listItem.className = 'article-list-item';
            listItem.setAttribute('data-doc-id', doc.id);
            listItem.innerHTML = `<h4>${item.title}</h4><p>${item.content ? item.content.substring(0, 100) + '...' : ''}</p>`;
            listItem.addEventListener('click', () => {
                carregarDetalhesArtigo(doc.id, item, listItem);
            });
            articleList.appendChild(listItem);
        });
    }).catch(error => {
        console.error("Erro ao carregar artigos:", error);
        articleList.innerHTML = '<p>Erro ao carregar artigos.</p>';
    });
}

// Adiciona eventos de clique para os filtros da barra lateral (Corrigido)
document.querySelectorAll('.nav-link-filter').forEach(link => {
    link.addEventListener('click', (e) => {
        e.preventDefault();
        document.querySelectorAll('.nav-link-filter').forEach(l => l.classList.remove('active'));
        e.target.classList.add('active');
        const filtro = e.target.dataset.filter;
        carregarArtigos(filtro);
    });
});

function carregarDetalhesArtigo(docId, item, listItem) {
    selectedArticleDocId = docId;
    selectedArticleData = item;
    document.querySelectorAll('.article-list-item').forEach(el => el.classList.remove('selected'));
    if (listItem) listItem.classList.add('selected');

    // Preparar o conteúdo da imagem
    let imageHtml = '';
    if (item.image_reference && item.image_reference.includes('[IMAGEM_ID:')) {
        const imageDocId = item.image_reference.split(':')[1].slice(0, -1);
        db.collection('imagenscode').doc(imageDocId).get().then(imageDoc => {
            if (imageDoc.exists) {
                const imageData = imageDoc.data();
                imageHtml = `<img src="data:image/png;base64,${imageData.base64_code}" style="max-width:100%; height:auto;">`;
                renderDetails();
            } else {
                renderDetails();
            }
        });
    } else {
        renderDetails();
    }

    function renderDetails() {
        articleDetails.innerHTML = `
            <h2>${item.title}</h2>
            <div class="info">
                <p><strong>Setor:</strong> ${item.sector}</p>
                <p><strong>UID do Documento:</strong> ${docId}</p>
                <p><strong>Autor:</strong> ${item.author_uid || 'N/A'}</p>
            </div>
            ${imageHtml}
            <div class="article-content">
                ${item.content || '<p>Sem descrição.</p>'}
            </div>
            <div class="article-actions">
                <button id="edit-article-button">Editar</button>
                <button id="view-history-button">Histórico</button>
            </div>
        `;
        document.getElementById('edit-article-button').addEventListener('click', () => {
            abrirFormularioEdicao();
        });
        document.getElementById('view-history-button').addEventListener('click', () => {
            abrirHistoricoArtigo();
        });
    }
}

// --- Lógica de Edição de Artigo (existente) ---
function abrirFormularioEdicao() {
    navigateTo('section-edit-article');
    document.getElementById('edicao-titulo').value = selectedArticleData.title;
    document.getElementById('edicao-setor').value = selectedArticleData.sector;
    document.getElementById('edicao-conteudo').value = selectedArticleData.content;
}

formEdicaoArtigo.addEventListener('submit', async (e) => {
    e.preventDefault();
    const novoTitulo = document.getElementById('edicao-titulo').value;
    const novoSetor = document.getElementById('edicao-setor').value;
    const novoConteudo = document.getElementById('edicao-conteudo').value;

    if (selectedArticleDocId) {
        try {
            await db.collection('wazzimagiyggfemboyverse69').doc(selectedArticleDocId).update({
                title: novoTitulo,
                sector: novoSetor,
                content: novoConteudo,
                ultimaEdicao: firebase.firestore.FieldValue.serverTimestamp(),
                editor_uid: auth.currentUser.uid,
            });
            alert("Artigo atualizado com sucesso!");
            navigateTo('section-all-articles');
            carregarArtigos();
        } catch (error) {
            console.error("Erro ao atualizar o artigo:", error);
            alert("Ocorreu um erro ao atualizar o artigo.");
        }
    }
});

document.getElementById('cancelar-edicao').addEventListener('click', () => {
    navigateTo('section-all-articles');
});

// --- Lógica do Perfil (existente) ---
profileLink.addEventListener('click', (e) => {
    e.preventDefault();
    navigateTo('profile-section');
    carregarMinhasContribuicoes();
    carregarPaginaPessoal();
});

// Placeholder para histórico do artigo
function abrirHistoricoArtigo() {
    navigateTo('section-article-history');
    document.getElementById('history-list').innerHTML = '<p>Funcionalidade de Histórico em desenvolvimento ou com erro no código original.</p>';
    document.getElementById('cancelar-historico').addEventListener('click', () => {
        navigateTo('section-all-articles');
    });
}
